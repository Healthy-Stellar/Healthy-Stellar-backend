import { Test, TestingModule } from '@nestjs/testing';
import { ConfigModule, ConfigService } from '@nestjs/config';
import { TypeOrmModule } from '@nestjs/typeorm';
import { AwsKmsService } from '../services/aws-kms.service';
import { KeyManagementModule } from '../key-management.module';
import { CircuitBreakerModule } from '../../common/circuit-breaker/circuit-breaker.module';
import { CommonModule } from '../../common/common.module';
import { TenantModule } from '../../tenant/tenant.module';
import { Tenant } from '../../tenant/entities/tenant.entity';
import { AuditLog } from '../../common/entities/audit-log.entity';

describe('KeyManagementService Integration', () => {
  let app: TestingModule;\n  let keyManagementService: AwsKmsService;\n  let configService: ConfigService;\n\n  beforeAll(async () => {\n    app = await Test.createTestingModule({\n      imports: [\n        ConfigModule.forRoot({\n          isGlobal: true,\n          envFilePath: '.env.test',\n        }),\n        TypeOrmModule.forRootAsync({\n          useFactory: () => ({\n            type: 'sqlite',\n            database: ':memory:',\n            entities: [Tenant, AuditLog],\n            synchronize: true,\n          }),\n        }),\n        KeyManagementModule,\n        CircuitBreakerModule,\n        CommonModule,\n        TenantModule,\n      ],\n    }).compile();\n\n    keyManagementService = app.get<AwsKmsService>('KeyManagementService');\n    configService = app.get<ConfigService>(ConfigService);\n  });\n\n  afterAll(async () => {\n    await app.close();\n  });\n\n  describe('AWS KMS Integration', () => {\n    beforeEach(() => {\n      // Skip if AWS credentials not available\n      const kmsEnabled = configService.get('KMS_ENABLED');\n      const awsAccessKey = configService.get('AWS_ACCESS_KEY_ID');\n      \n      if (kmsEnabled !== 'true' || !awsAccessKey) {\n        console.log('Skipping AWS KMS integration tests - credentials not configured');\n        return;\n      }\n    });\n\n    it('should generate and decrypt data key with real KMS', async () => {\n      const kmsEnabled = configService.get('KMS_ENABLED');\n      if (kmsEnabled !== 'true') {\n        console.log('Skipping - KMS not enabled');\n        return;\n      }\n\n      const patientId = 'integration-test-patient';\n      \n      // Generate data key\n      const dataKey = await keyManagementService.generateDataKey(patientId);\n      \n      expect(dataKey.encryptedKey).toBeInstanceOf(Buffer);\n      expect(dataKey.plainKey).toBeInstanceOf(Buffer);\n      expect(dataKey.plainKey).toHaveLength(32); // AES-256\n      \n      // Decrypt the same key\n      const decryptedKey = await keyManagementService.decryptDataKey(\n        dataKey.encryptedKey,\n        patientId\n      );\n      \n      expect(decryptedKey).toEqual(dataKey.plainKey);\n    });\n\n    it('should handle key rotation', async () => {\n      const kmsEnabled = configService.get('KMS_ENABLED');\n      if (kmsEnabled !== 'true') {\n        console.log('Skipping - KMS not enabled');\n        return;\n      }\n\n      const patientId = 'rotation-test-patient';\n      \n      await expect(\n        keyManagementService.rotatePatientKey(patientId)\n      ).resolves.not.toThrow();\n    });\n\n    it('should handle key destruction', async () => {\n      const patientId = 'destruction-test-patient';\n      \n      await expect(\n        keyManagementService.destroyPatientKeys(patientId)\n      ).resolves.not.toThrow();\n    });\n  });\n\n  describe('Local Development Mode', () => {\n    it('should work in local mode', async () => {\n      // Force local mode for this test\n      jest.spyOn(configService, 'get').mockImplementation((key: string) => {\n        if (key === 'KMS_ENABLED') return 'false';\n        if (key === 'LOCAL_KEK') return 'test-key-encryption-key-32-chars';\n        return configService.get(key);\n      });\n\n      const patientId = 'local-test-patient';\n      \n      // Generate data key locally\n      const dataKey = await keyManagementService.generateDataKey(patientId);\n      \n      expect(dataKey.encryptedKey).toBeInstanceOf(Buffer);\n      expect(dataKey.plainKey).toBeInstanceOf(Buffer);\n      expect(dataKey.plainKey).toHaveLength(32);\n      \n      // Decrypt locally\n      const decryptedKey = await keyManagementService.decryptDataKey(\n        dataKey.encryptedKey,\n        patientId\n      );\n      \n      expect(decryptedKey).toEqual(dataKey.plainKey);\n    });\n  });\n\n  describe('Circuit Breaker Integration', () => {\n    it('should handle circuit breaker failures gracefully', async () => {\n      // This test would require mocking the circuit breaker to fail\n      // Implementation depends on specific circuit breaker behavior\n      const patientId = 'circuit-breaker-test';\n      \n      // Test should pass without throwing unhandled exceptions\n      await expect(\n        keyManagementService.generateDataKey(patientId)\n      ).resolves.toBeDefined();\n    });\n  });\n});